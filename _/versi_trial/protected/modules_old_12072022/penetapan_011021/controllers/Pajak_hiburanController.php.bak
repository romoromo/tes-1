<?php

class Pajak_hiburanController extends Controller
{
    public function init()
    {
        Yii::import('ext.DBFetch');
    }

    public function actionIndex()
    {   
        $data['kecamatan'] = TBLKECAMATAN::model()->findAll( 'TBLKABUPATEN_KODE=3471' );
        $data['total_data'] = 100000000000;
        // $data['kelurahan'] = Kelurahan::model()->findAll();
        $this->renderPartial('index', array('data'=>$data));
    }

    public function actionGetData()
    {
        $TBLDAFTHIBURAN_THNPAJAK = (int)DMOrcl::getRequest('param', 'TBLDAFTHIBURAN_THNPAJAK');
        $TBLDAFTHIBURAN_BLNPAJAK = $_REQUEST['TBLDAFTHIBURAN_BLNPAJAK'];
        $data['nourut'] = $TBLDAFTHIBURAN_URUTSKPD = (int)DMOrcl::getRequest('param', 'TBLDAFTHIBURAN_URUTSKPD');
        $TBLKECAMATAN_ID = !empty(DMOrcl::getRequest('param', 'TBLKECAMATAN_ID')) ? (int)DMOrcl::getRequest('param', 'TBLKECAMATAN_ID') : '';
        $TBLDAFTREKLAME_ISJNSPENETAPAN = DMOrcl::getRequest('param', 'TBLDAFTREKLAME_ISJNSPENETAPAN');
        $TBLDAFTHIBURAN_TGLENTRI = strtotime($_REQUEST['param']['TBLDAFTHIBURAN_TGLENTRI']) ? date('Y-m-d', strtotime($_REQUEST['TBLDAFTHIBURAN_TGLENTRI'])) : '';
        $data['tglskpd'] = strtotime($_REQUEST['param']['TBLDAFTHIBURAN_TGLSKPD']) ? date('Y-m-d', strtotime($_REQUEST['TBLDAFTHIBURAN_TGLSKPD'])) : '';
        // $data['tglskpd'] = $TBLDAFTHIBURAN_TGLSKPD = strtotime($_REQUEST['param']['TBLDAFTHIBURAN_TGLSKPD']) ? date('Y-m-d', strtotime($_REQUEST['TBLDAFTHIBURAN_TGLSKPD'])) : '';
        
        $exptglentri = explode('-', $TBLDAFTHIBURAN_TGLENTRI);
        $tglentri = $exptglentri[1];

        $select = "
            CONCAT (
            TBLDAFTHIBURAN_TGLSKPD,
                CONCAT (
                    '/',
                    CONCAT (
                        TBLDAFTHIBURAN_BLNSKPD,
                        (
                            CONCAT (
                                '/20',
                                TBLDAFTHIBURAN_THNSKPD
                            )
                        )
                    )
                )
            ) AS TGL_SKPD,
            TNPWPD.TNPWPD_NOPOK AS TNPWPD_NOPOK,
            TSUBYEK.TSUBYEK_BUNAMAMERK AS NAMA_USAHA,
            TNPWPD.TNPWPD_GOL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLPAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNPAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNPAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_PAJAKKE,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_JNSPENDAPATAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_GOLONGAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_NOPOK,
            TBLDAFTHIBURAN.TBLKECAMATAN_ID,
            TBLDAFTHIBURAN.TBLKELURAHAN_ID,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKURUSAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKPEMERINTAHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKORGANISASI,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKPROGRAM,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKKEGIATAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKDINAS,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKBIDANG,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKPENDAPATAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKPAD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKPAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKAYAT,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKJENIS,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKSUBJENIS,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REKBADANUSAHA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISKAS,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISPEMBUKUAN,
            TBLDAFTHIBURAN.LHP,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISNOTA,
            TBLDAFTHIBURAN.TIHU,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISJNSPENETAPAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNMULAIJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNMULAIJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLMULAIJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNAKHIRJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNAKHIRJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLAKHIRJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_JUMLAHHARIJUAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_OMSETPAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_PERSENTARIF,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_PAJAK,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYATSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BUNGASPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNBATASSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNBATASSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLBATASSPTPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNTERIMA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNTERIMA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLTERIMA,
            CONCAT (
                    TBLDAFTHIBURAN_TGLENTRI,
                    CONCAT (
                        '/',
                        CONCAT (
                            TBLDAFTHIBURAN_BLNENTRI,
                            (
                                CONCAT (
                                    '/20',
                                    TBLDAFTHIBURAN_THNENTRI
                                )
                            )
                        )
                    )
                ) AS TBLDAFTHIBURAN_TGLENTRI,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYATSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_NOMORSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_URUTSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_PAJAKSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNBATASSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNBATASSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLBATASSKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THTERIMASKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNTERIMASKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLTERIMASKPD,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_NOMORPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_OMSETPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_PAJAKPERIKSA,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYTKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REGKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_URUTKURANGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_KURANGBAYARKE,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BUNGAKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_DENDAKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_RUPIAHKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNBTSKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNBTSKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLBTSKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNTRMKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNTRMKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLTRMKRGBAYAR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TAHUNNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BULANNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TANGGLNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYATNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REGNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_URUTNIHIL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TAHUNSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BULANSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TANGGALSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYATSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REGSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_SETORKE,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_RUPIAHSETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TIPESETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISLUNAS,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNENTRISETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNENTRISETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLENTRISETOR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNSURATTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNSURATTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLSURATTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_AYTSURATTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_NOSURATTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_SURATTAGIHANKE,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BUNGATAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_DENDATAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_RUPIAHTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNBTSTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNBTSTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLBTSTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNTRMTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNTRMTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLTRMTAGIHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNSURATANGSUR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNSURATANGSUR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_TGLSURATANGSUR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_REGSURATANGSUR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNKBAWAL,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNKBALIR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_JUMLAHANGSUR,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_POKOKTAMBAHAN,
            TBLDAFTHIBURAN.TBLDAFTHIBURAN_BUNGATAMBAHAN
        ";
        $from = 'TBLDAFTHIBURAN';
        $filter = array(
             'EQ__TBLDAFTHIBURAN.TBLDAFTHIBURAN_THNPAJAK' => substr($TBLDAFTHIBURAN_THNPAJAK, -2)
            ,'EQ__TBLDAFTHIBURAN.TBLDAFTHIBURAN_BLNPAJAK'=>(int) $TBLDAFTHIBURAN_BLNPAJAK
            // ,'EQ__TBLDAFTHIBURAN.TBLKECAMATAN_ID' => $TBLKECAMATAN_ID
            // ,'EQ__TBLDAFTHIBURAN.TBLDAFTHIBURAN_ISJNSPENETAPAN' => $TBLDAFTHIBURAN_ISJNSPENETAPAN
            //,'EQ__TBLDAFTHIBURAN_TGLENTRI'=>$tglentri
        );

        $otherquery = array(
             'leftjoin_TNPWPD'=>array('TNPWPD','TNPWPD.TNPWPD_NOPOK=TBLDAFTHIBURAN.TBLDAFTHIBURAN_NOPOK')
            ,'leftjoin_TSUBYEK'=>array('TSUBYEK','TSUBYEK.TSUBYEK_ID=TNPWPD.TSUBYEK_ID')
            ,'leftjoin_REFKECAMATAN'=>array('REFKECAMATAN','REFKECAMATAN.REFKECAMATAN_ID=TBLDAFTHIBURAN.TBLKECAMATAN_ID')
            ,'leftjoin_REFKELURAHAN'=>array('REFKELURAHAN','REFKELURAHAN.REFKELURAHAN_ID=TBLDAFTHIBURAN.TBLKELURAHAN_ID')
            ,'andwhere'=> '
            NVL (TBLDAFTHIBURAN_URUTSKPD, 0) = 0
            '/*-- AND TNPWPD.TNPWPD_NOPOK <> 0
            -- AND TNPWPD.TNPWPD_NOPOK <> 150000'*/
        );

        $arrayConfig = array('select'=>$select,'from'=>$from,'filter'=>$filter,'otherquery'=>$otherquery,'mode'=>'LIST');
        $data['ketetapan'] = DBFetch::query($arrayConfig);

        $this->renderPartial('grid', array('data'=>$data));
    }

    public function actionTetapkanPajakHiburan()
    {
        $listPajakHiburan = trim($_REQUEST['listPajakHiburan'],',');
        $TBLDAFTHIBURAN_THNPAJAK = $_REQUEST['TBLDAFTHIBURAN_THNPAJAK'];
        $TBLDAFTHIBURAN_BLNPAJAK = $_REQUEST['TBLDAFTHIBURAN_BLNPAJAK'];
        $TBLDAFTHIBURAN_TGLSKPD = date('Y-m-d',strtotime( $_REQUEST['TBLDAFTHIBURAN_TGLSKPD'] ));
        $TBLDAFTHIBURAN_TGLBATASSKPD = date('Y-m-d',strtotime( $_REQUEST['TBLDAFTHIBURAN_TGLBATASSKPD'] ));

        $THNPAJAK = substr($TBLDAFTHIBURAN_THNPAJAK, -2);
        $BLNPAJAK = (int)$TBLDAFTHIBURAN_BLNPAJAK;
        $TGLSKPD = explode('-', $TBLDAFTHIBURAN_TGLSKPD);
        $TGLBATASSKPD = explode('-', $TBLDAFTHIBURAN_TGLBATASSKPD);

        $PajakAirList = explode(',', $listPajakHiburan);
        foreach ($PajakAirList as $list) {
            $expList = explode('-', $list);
            $nopokok = $expList[0]; 
            $nourut = $expList[1];
            $pajak = $expList[2]!='' ? $expList[2] : 0;

            $update = Yii::app()->db->createCommand();

            $query = $update->update('TBLDAFTHIBURAN', array(
                 'TBLDAFTHIBURAN_THNSKPD' => substr($TGLSKPD[0], -2)
                ,'TBLDAFTHIBURAN_BLNSKPD' => (int) $TGLSKPD[1]
                ,'TBLDAFTHIBURAN_TGLSKPD' => $TGLSKPD[2]
                ,'TBLDAFTHIBURAN_NOMORSKPD' => $nourut
                ,'TBLDAFTHIBURAN_URUTSKPD' => $nourut
                ,'TBLDAFTHIBURAN_PAJAKSKPD' => $pajak
                ,'TBLDAFTHIBURAN_THNBATASSKPD' => substr($TGLBATASSKPD[0], -2)
                ,'TBLDAFTHIBURAN_BLNBATASSKPD' => (int) $TGLBATASSKPD[1]
                ,'TBLDAFTHIBURAN_TGLBATASSKPD' => $TGLBATASSKPD[2]
            ), 'TBLDAFTHIBURAN_NOPOK=:nopok AND TBLDAFTHIBURAN_THNPAJAK=:thn AND TBLDAFTHIBURAN_BLNPAJAK=:bln', array(':nopok'=>$nopokok,':thn'=>$THNPAJAK,':bln'=>$BLNPAJAK));

            if ($query>0) {
                echo CJSON::encode(array('status'=>'success','nopokok'=>$nopokok));
            }
            else{
                echo CJSON::encode(array('status'=>'failed','nopokok'=>$nopokok));
            }

            /*print_r($query);*/
        }
    }

    // Uncomment the following methods and override them if needed
    /*
    public function filters()
    {
        // return the filter configuration for this controller, e.g.:
        return array(
            'inlineFilterName',
            array(
                'class'=>'path.to.FilterClass',
                'propertyName'=>'propertyValue',
            ),
        );
    }

    public function actions()
    {
        // return external action classes, e.g.:
        return array(
            'action1'=>'path.to.ActionClass',
            'action2'=>array(
                'class'=>'path.to.AnotherActionClass',
                'propertyName'=>'propertyValue',
            ),
        );
    }
    */
}